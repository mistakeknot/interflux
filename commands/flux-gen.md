---
name: flux-gen
description: Generate project-specific review agents from detected domain profiles
argument-hint: "[optional: domain name to generate for, or 'all' for all detected domains]"
---

# Flux-Gen — Domain-Specific Agent Generator

Generate project-specific `fd-*` review agents in `.claude/agents/` based on the project's detected domain profiles. These agents complement the core flux-drive plugin agents with deeper, domain-specific review expertise.

## Step 1: Detect Project Domains

If `$ARGUMENTS` specifies a domain name (e.g., `game-simulation`), skip detection and use that domain directly. If `$ARGUMENTS` is `all` or empty, detect domains.

**Cache check:** Read `{PROJECT_ROOT}/.claude/flux-drive.yaml`. If it exists with `domains:` entries and `content_hash:` matches current project files, use cached results. If `override: true`, always use cached.

**Detection** (no cache, stale cache, or `source: heuristic`):

Use the same LLM-based detection as flux-drive. Launch a Haiku subagent (Task tool, `model: haiku`) that reads README + build file + 2-3 key source files and classifies into 11 known domains. Cache the result with `source: llm` and `content_hash`.

**Heuristic fallback** (if Haiku fails):
```bash
python3 ${CLAUDE_PLUGIN_ROOT}/scripts/detect-domains.py {PROJECT_ROOT} --json
```
Mark `source: heuristic` in cache.

If no domains detected and no argument provided, tell the user:
> No domains detected for this project.
>
> **Available domains:** game-simulation, web-api, ml-pipeline, cli-tool, mobile-app, embedded-systems, data-pipeline, library-sdk, tui-app, desktop-tauri, claude-code-plugin
>
> **To specify manually:** `/flux-gen game-simulation` (or any domain above)
> **To skip domain agents:** Run `/flux-drive` directly — core agents work without domain specialization

## Step 2: Preview Generation

Run the shared generation script in dry-run mode to show what would be generated:

```bash
python3 ${CLAUDE_PLUGIN_ROOT}/scripts/generate-agents.py {PROJECT_ROOT} --mode=skip-existing --dry-run --json
```

Parse the JSON report to count new agents vs existing agents. Present to the user.

## Step 3: Confirm

Use **AskUserQuestion** to confirm:
- Option 1: "Generate N new agents (skip M existing)" (Recommended) → `--mode=skip-existing`
- Option 2: "Regenerate all (overwrite existing)" → `--mode=force`
- Option 3: "Cancel"

## Step 4: Generate

Run the generation script with the selected mode:

```bash
python3 ${CLAUDE_PLUGIN_ROOT}/scripts/generate-agents.py {PROJECT_ROOT} --mode=<selected-mode> --json
```

Parse the JSON report and display per-agent results.

## Step 5: Report

After generation, present a summary:

```
Generated {N} project-specific agents in .claude/agents/:

Domain: {domain-name} ({confidence})
  - fd-{name1}: {Focus line} [created]
  - fd-{name2}: {Focus line} [skipped — up-to-date]

These agents will be included in flux-drive triage as Project Agents
(+1 category bonus). Customize them by editing the .md files directly.

To use them in a review: /flux-drive <target>
To regenerate: /flux-gen (existing agents are preserved unless you choose overwrite)
```

## Notes

- Generated agents use `subagent_type: general-purpose` in flux-drive (their full content is pasted as the system prompt)
- Project Agents get +1 category bonus in triage scoring
- Multiple domains may generate overlapping agents — flux-drive deduplication handles this (prefer Project > Plugin)
- Users should customize generated agents for their specific project needs
- `flux_gen_version: 4` agents have persona, decision lens, anti-overlap clauses, and success criteria; older versions are auto-regenerated by `--mode=regenerate-stale`
- Generation is deterministic — same domain profile always produces the same agent file (no LLM involvement in template expansion)
